<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title>Second Life maptest with Mapbox</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
  </style>
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
  <div id='map'></div>
  <script>
      function urlmath(s)
      { //  Tile remapping algorithm
        //
        //  SL tile numbers are X and Y values in  the range 0..2^20
        //  Match expression always removes operation if it matches, so loop is safe.
        //
        //  The style file, in JSON, in its "tiles" URL field, should have an expression like
        //  
        //  SLTILENUM({x},{y},{z})
        //
        //  Mapbox will fill in {x},{y},{z}. This code will rewrite SLTILENUM forms into SL tile numbers.
        //
        //  SL map units
        //  Per "http://wiki.secondlife.com/wiki/Map_API_Introduction"
        const SLGRIDEDGESIZEPOWER = 20;     // Grid size in regions, exponent
        const SLGRIDEDGESIZEINREGIONS = Math.pow(2,SLGRIDEDGESIZEPOWER);
        const SLMINLAT = 0.0;               // corresponds to tile 0,0
        const SLMINLNG = 0.0;
        const SLMAXLAT = 90.0;              // corresponds to tile (2^20, 2^20)
        const SLMAXLNG = 90.0;
        const SLZOOMMIN = 1;                // zoomed in fully, 1 tile = 1 unit
        const SLZOOMMAX = 8;                // zoomed out fully
        //  Mapbox units
        //  Per "https://en.wikipedia.org/wiki/Web_Mercator_projection"
        const MBLATLIM = 85.051129;         // Cylindrical projection of a sphere limited before Y goes infinite.
        const MBMINLAT = -90.0;
        const MBMAXLAT = 90.0;
        const MBMINLNG = -180.0;
        const MBMAXLNG = 180.0;
        //  In Mapbox, at zoom level 0, 1 tile fills the area to += MBLATLIM
        //  X goes from 0 (left edge is 180 °W) to 2^zoom − 1 (right edge is 180 °E)
        //  Y goes from 0 (top edge is 85.0511 °N) to 2^zoom − 1 (bottom edge is 85.0511 °S) in a Mercator projection
        //  Ref: https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames#X_and_Y
        //  So we want to map zoom as follows:
        //  mlz=20 => slz=8
        //  slz = SLGIDSIZEPOWER + 1 - mlz // mlz=20 => slz=1
        //  scale = Math.pow(2,SLZOOMMAX-slz) // slz=8 => scale=1
        //  slx = mlx*scale - (SLGRIDEDGESIZEINREGIONS/2)
        //  sly = (SLGRIDEDGESIZEINREGIONS/2) - mly*scale   because Mapbox Y axis from the top edge down
        //  Range for mlz: [13..20]
        //  Range for lat/lng: [0..90]
        var changed = false;
        var match;
        do
        {   changed = false;       
            if (match = /SLTILENUM\(([0-9]+),([0-9]+),([0-9]+)\)/.exec(s))
            {   var x = parseInt(match[1]);
                var y = parseInt(match[2]);
                var z = parseInt(match[3]);
                var slz = SLGRIDEDGESIZEPOWER + 1 - z; // mlz=20 => slz=1
                var scale = Math.pow(2,slz-1)           // slz=1 => scale=1
                var slx = x * scale - (SLGRIDEDGESIZEINREGIONS/2);   
                var sly = (SLGRIDEDGESIZEINREGIONS/2) - (y+1) * scale;   // Reversed! See above.  (y+1) makes it work, but why?
                var tileid = slz.toString() + '-' + slx.toString() + '-' + sly.toString();
                s = s.replace(match[0], tileid);
                console.log("Tile request: " + match[0] + " -> " + tileid + "  Center: " + map.getCenter() + " Zoom: " + map.getZoom()); // ***TEMP***
                changed = true;
            }
        } while (changed);
        ////console.log("Tile: " + s);                // ***TEMP**
        return s;
      }
  var map = new mapboxgl.Map({
      container: 'map',
      style: 'slflatmap/style.json',
      center: [0.34219039050572064, 0.3426164100134912],       // DA BOOM, tile 1000,1000
      zoom: 18,
      maxZoom: 20,                                             // As far as we can go.
      minZoom: 12,
      maxBounds: [0.0, 0.0, 1.0, 1.0],                         // lat/long limits of the SL world, with some allowance for expansion.
      interactive: true,
      
      transformRequest: (url, resourceType)=> {
        if(resourceType === 'Tile' && url.startsWith('')) {
            url = urlmath(url); // apply ADD rewriting
            return {
                url: url /// .replace('https', 'https://cors-anywhere.herokuapp.com/https')////,
                ////headers: { 'Origin': 'null'},
                ////credentials: 'include'  // Include cookies for cross-origin requests
                    }
                }
            }     
        }
    );
  </script>
</body>